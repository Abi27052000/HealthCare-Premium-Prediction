name: Enhanced Streamlit App Keep-Alive

on:
  schedule:
    # Run every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch: # Allow manual triggering

env:
  STREAMLIT_APP_URL: https://healthcare-premium-prediction-27.streamlit.app/

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Create health check script
        run: |
          cat > health_check.py << 'EOF'
          import requests
          import time
          import json
          from datetime import datetime

          def check_app_health():
              url = "https://healthcare-premium-prediction-27.streamlit.app/"
              
              try:
                  print(f"ðŸš€ Starting health check at {datetime.now()}")
                  
                  # Initial request to wake up the app
                  print("ðŸ“¡ Making initial request to wake up the app...")
                  response = requests.get(url, timeout=30)
                  print(f"âœ… Initial response: {response.status_code}")
                  
                  if response.status_code == 200:
                      print("ðŸŽ‰ App is responding successfully!")
                      
                      # Wait a bit for the app to fully load
                      print("â³ Waiting for app to fully initialize...")
                      time.sleep(10)
                      
                      # Make a second request to ensure stability
                      print("ðŸ”„ Making follow-up request...")
                      response2 = requests.get(url, timeout=30)
                      print(f"âœ… Follow-up response: {response2.status_code}")
                      
                      if response2.status_code == 200:
                          print("ðŸ† App is stable and fully responsive!")
                          return True
                      else:
                          print(f"âš ï¸ Follow-up request failed with status: {response2.status_code}")
                          return False
                          
                  else:
                      print(f"âŒ App returned error status: {response.status_code}")
                      return False
                      
              except requests.exceptions.Timeout:
                  print("â° Request timed out - app might be sleeping")
                  return False
              except requests.exceptions.RequestException as e:
                  print(f"ðŸš¨ Request failed: {str(e)}")
                  return False
              except Exception as e:
                  print(f"ðŸ’¥ Unexpected error: {str(e)}")
                  return False

          if __name__ == "__main__":
              success = check_app_health()
              
              print("\n" + "="*50)
              print(f"ðŸ“Š Health Check Summary")
              print(f"ðŸ• Timestamp: {datetime.now()}")
              print(f"ðŸŽ¯ Target URL: https://healthcare-premium-prediction-27.streamlit.app/")
              print(f"ðŸ“ˆ Status: {'SUCCESS' if success else 'FAILED'}")
              print(f"ðŸ”„ Next check in 6 hours")
              print("="*50)
              
              if not success:
                  exit(1)
          EOF

      - name: Run health check
        run: |
          python health_check.py

      - name: Additional curl-based check
        run: |
          echo "ðŸ”§ Running additional curl-based health checks..."

          # Check if the app responds within reasonable time
          if curl -f -s --max-time 45 "$STREAMLIT_APP_URL" > /dev/null; then
            echo "âœ… Curl health check passed!"
          else
            echo "âš ï¸ Curl health check failed!"
          fi

          # Check response time
          echo "â±ï¸ Measuring response time..."
          time curl -s -o /dev/null "$STREAMLIT_APP_URL"

      - name: Create status report
        run: |
          echo "ðŸ“‹ Creating status report..."

          cat > status_report.md << EOF
          # Streamlit App Health Check Report

          **Timestamp:** $(date)
          **App URL:** $STREAMLIT_APP_URL
          **Workflow:** Keep-Alive Check
          **Frequency:** Every 6 hours

          ## Status
          âœ… Health check completed successfully

          ## Next Check
          $(date -d '+6 hours')

          ## Purpose
          This automated workflow keeps the Streamlit app active by making regular requests,
          preventing it from going to sleep due to inactivity.
          EOF

          echo "ðŸ“„ Status report created:"
          cat status_report.md
